FROM python:3.10-slim

# Create non-root user for security
RUN useradd -m -s /bin/bash mcp-user

# Install server dependencies
RUN apt-get update && apt-get install -y nodejs npm && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set up secure directory permissions
WORKDIR /app

# Copy files from the deployment directory
COPY templates/server.py .
COPY adapters/stdio_adapter.py .

# Install adapter requirements
RUN pip install --no-cache-dir aiohttp requests

# Set server command and args from environment
ENV SERVER_NAME="filesystem"
ENV SERVER_COMMAND="npx"
ENV SERVER_ARGS="-y @modelcontextprotocol/server-filesystem /data"

# Create secured data directory with proper permissions
RUN mkdir -p /data && chown -R mcp-user:mcp-user /data

# Drop privileges to non-root user
USER mcp-user

EXPOSE 8000
CMD ["python", "server.py"]