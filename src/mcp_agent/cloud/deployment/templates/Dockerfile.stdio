FROM python:3.10-slim

# Create non-root user for security
RUN useradd -m -s /bin/bash mcp-user

# Install server dependencies
RUN apt-get update && apt-get install -y nodejs npm && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set up secure directory permissions
WORKDIR /app
COPY stdio_adapter.py .
COPY server.py .

# Install adapter requirements
RUN pip install --no-cache-dir aiohttp

# Set server command and args (these are replaced at build time)
ENV SERVER_COMMAND="${SERVER_COMMAND}"
ENV SERVER_ARGS="${SERVER_ARGS}"

# Create secured data directory with proper permissions
RUN mkdir -p /data && chown -R mcp-user:mcp-user /data

# Drop privileges to non-root user
USER mcp-user

EXPOSE 8000
CMD ["python", "server.py"]